#!/usr/bin/env ruby

################################################################################
################################################################################
######                                                                    ######
####                                                                        ####
###                                                                          ###
##          oooooooooo.                                                       ##
##          `888'   `Y8b                                                      ##
##           888     888 oooo    ooo oooo d8b  .ooooo.  ooo. .oo.             ##
##           888oooo888'  `88.  .8'  `888""8P d88' `88b `888P"Y88b            ##
##           888    `88b   `88..8'    888     888   888  888   888            ##
##           888    .88P    `888'     888     888   888  888   888            ##
##          o888bood8P'      .8'     d888b    `Y8bod8P' o888o o888o           ##
##                       .o..P'                                               ##
###                      `Y8P'                                               ###
###                                                                          ###
####                                                                        ####
######                                                                    ######
################################################################################
################################################################################

require 'optparse'
require 'pp'
require 'yaml'

require_relative '../lib/byron'
require_relative '../lib/byron/scanner'
require_relative '../lib/byron/parser'
require_relative '../lib/byron/evaluator'

# Byron class to be used and reused.
$byron = Byron.new

HELP =  <<-EOH
Usage: byron [<command>] [options] [< in [> out]] [file]

Commands:
  scan
  read
  evaluate

Options:
  -u, --use <plugin>,...      Use one or more plugins
  -r, --reporter <reporter>   Set the reporter to use
  -i, --interactive           Start an interactive console
  -v, --version               Print out Byron version
  -h, --help                  Display this help text
EOH

repl = false
plugins = []

OptionParser.new do |opts|

  opts.on '-u', '--use', Array do |plugins|
    $byron.use *plugins
  end

  opts.on '-r', '--reporter' do |reporter|
  end

  opts.on '-i', '--interactive', '--repl' do
    repl = true
  end

  opts.on '-v', '--version' do
    puts Byron::VERSION
  end

  opts.on '-h', '--help' do
    puts HELP
  end

end.parse!

def evaluate text
  begin
    document = $byron.scan text
    discourse = $byron.parse document
    puts discourse.to_yaml
  rescue Exception => e
    puts "\x1b[33m#{e.message}\x1b[0m"
    puts "\x1b[33m#{e.backtrace.inspect}\x1b[0m"
  end
end

ARGV.each do |file|
  text = File.read file
  evaluate text
end

if repl
  begin
    loop do

      print '> '

      if text = gets
        unless text.strip! == ''
          evaluate text
          next
        end
      end

    end
  rescue Exception => e
    raise e
  end
end
