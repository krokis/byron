#!/usr/bin/env ruby

require 'optparse'
require 'pp'
require 'yaml'

require_relative '../lib/byron'
require_relative '../lib/scanner'
require_relative '../lib/parser'
require_relative '../lib/evaluator'

##
# Byron class to be used and reused
#
$byron = Byron.new

HELP =  <<-EOH
Usage: byron [<command>] [options] [< in [> out]] [file]

Commands:
  scan
  read
  evaluate

Options:
  -u, --use <plugin>,...      Use one or more plugins
  -r, --reporter <reporter>   Set the reporter to use
  -i, --interactive           Start an interactive console
  -v, --version               Print out Byron version
  -h, --help                  Display this help text
EOH

repl = false
plugins = []

OptionParser.new do |opts|

  opts.on '-u', '--use', Array do |plugins|
    $byron.use *plugins
  end

  opts.on '-r', '--reporter' do |reporter|
  end

  opts.on '-i', '--interactive', '--repl' do
    repl = true
  end

  opts.on '-v', '--version' do
    puts '0.0.1'
  end

  opts.on '-h', '--help' do
    puts HELP
  end

end.parse!

def evaluate(text)
  begin
    discourse = $byron.parse text
    puts discourse.to_yaml
  rescue Exception => e
    puts "\x1b[33m#{e.message}\x1b[0m"
    puts "\x1b[33m#{e.backtrace.inspect}\x1b[0m"
  end
end

ARGV.each do |file|
  puts file
end

if repl
  begin
    loop do

      print '> '

      if text = gets
        unless text.strip == ''
          evaluate text
          next
        end
      end

    end
  rescue e
    raise e
  end
end
